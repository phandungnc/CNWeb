-- 1. vai trò
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(20) UNIQUE NOT NULL -- ADMIN, TEACHER, STUDENT
);

-- 2. người dùng
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    user_code VARCHAR(20) UNIQUE NOT NULL, -- Mã số SV/GV
    email VARCHAR(50) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role_id INTEGER REFERENCES roles(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. sessions
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY,
    user_id INTEGER  REFERENCES users(id) ON DELETE CASCADE,
    refresh_token TEXT NOT NULL UNIQUE,
    expiry_date TIMESTAMP NOT NULL,
    created_at DEFAULT TIMESTAMP CURRENT_TIMESTAMP,

);

-- 4. lớp học
CREATE TABLE classes (
    id SERIAL PRIMARY KEY,
    class_code VARCHAR(20) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 5. bảng liên kết Học sinh/Giáo viên vào Lớp
CREATE TABLE class_members (
    class_id INTEGER REFERENCES classes(id) ON DELETE CASCADE,
    user_id INTEGER  REFERENCES users(id) ON DELETE CASCADE,
    PRIMARY KEY (class_id, user_id)
);

-- 6. khóa học của môn nào đó
CREATE TABLE courses (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    note TEXT,
    start_time TIMESTAMP, -- Thời gian bắt đầu khóa học
    end_time TIMESTAMP,   -- Thời gian kết thúc khóa học
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 7. gán Lớp vào khóa học
CREATE TABLE course_classes (
    course_id INTEGER REFERENCES courses(id) ON DELETE CASCADE,
    class_id INTEGER REFERENCES classes(id) ON DELETE CASCADE,
    PRIMARY KEY (course_id, class_id)
);

-- 8. ngân hàng
CREATE TABLE bank (
    id SERIAL PRIMARY KEY,
    course_id INTEGER REFERENCES courses(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    question_type VARCHAR(20) NOT NULL, -- SINGLE (1 chọn), MULTIPLE (nhiều chọn)
    created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- 9. các lựa chọn trong câu hỏi và đáp án
CREATE TABLE question_options (
    id SERIAL PRIMARY KEY,
    question_id INTEGER REFERENCES bank(id) ON DELETE CASCADE,
    option_text TEXT NOT NULL,
    is_correct BOOLEAN DEFAULT FALSE
);

-- 10. đề thi
CREATE TABLE exams (
    id SERIAL PRIMARY KEY,
    course_id INTEGER REFERENCES courses(id) ON DELETE CASCADE,
    title VARCHAR(100) NOT NULL,
    duration_minutes INTEGER NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
      created_by INTEGER REFERENCES users(id) ON DELETE SET NULL
);

– 11. Câu hỏi trong đề thi (Lấy từ ngân hàng)
CREATE TABLE exam_questions (
    exam_id INTEGER REFERENCES exams(id) ON DELETE CASCADE,
    question_id BIGINT REFERENCES bank(id) ON DELETE CASCADE,
    PRIMARY KEY (exam_id, question_id)
);

-- Lượt làm bài của sinh viên
CREATE TABLE exam_submissions (
    id SERIAL PRIMARY KEY,
    exam_id INTEGER REFERENCES exams(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    submit_time TIMESTAMP,
    score NUMERIC(5, 2) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'IN_PROGRESS', -- IN_PROGRESS, SUBMITTED
);

-- câu trả lời của học sinh
CREATE TABLE student_responses (
    id SERIAL PRIMARY KEY,
    submission_id INTEGER REFERENCES exam_submissions(id) ON DELETE CASCADE,
    question_id INTEGER REFERENCES question_bank(id),
    option_id BIGINT REFERENCES question_options(id), -- Option sinh viên chọn
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_response UNIQUE (submission_id, question_id, option_id)
);
